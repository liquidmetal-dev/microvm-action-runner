## microvm-action-runner

This is a POC service for creating on-the-fly self-hosted action runners on
[flintlock][flint] microvms.

### Usage

Clone and build the binary:

```bash
git clone https://github.io/weaveworks-liquidmetal/microvm-action-runner
cd microvm-action-runner
make build
```

Start the service:

```bash
./microvm-action-runner start \
	--host <flintlock address and port> \
	--token <pat token>

# run --help for more flag options

# more flintlock hosts can be added with additional `host` flags
# eg, --host foo:9090 --host bar:9090
#     or --hosts foo:9090,bar:9090
```

### Setup

1. Start a `flintlockd` service. Note the address and port.

1. Create a Github PAT token with `repo` scope.

1. Start the service.

1. Expose the service.

1. Navigate to the repo/org/ent where you want to use these runners.

1. Go to `Settings` then `Webhooks`.

1. Select `Add webhook`.

1. Fill in the `Payload URL` with your `https` url plus `/webhook`.
	eg: `https://my-service.org/webhook`.

1. Change the `Content type` to be `application/json`.

1. If you wish to set a plaintext secret, set that in the `Secret` field.
	Remember to restart the service with the `--secret` flag.

1. For the question `Which events would you like to trigger this webhook?`,
	select `Let me select individual events.`, then from the expanded options
	_deselect_ `Pushes`, and _select_ `Workflow jobs`.

1. Click `Add webhook`.

Your service should now be ready to receive webhook requests from workflow jobs
in that repo/org/ent.

### Contributing / Local Development

1. Fork the repo.

1. Clone your fork.

1. Run `make test`.

1. Make your changes, ensuring there are new tests and everything passes.

1. Manually test using `ngrok` (below). (Integration/acceptance tests are coming, for now
we must manually verify).

1. Open a PR.

#### Local testing

To check out the service without going to the effort of exposing the service
properly, you can use [`ngrok`][ngrok]. You can get a free plan as an individual.

After you have started your `microvm-action-runner` service, use `ngrok` to expose it:

```
ngrok http localhost:3000
```

Use the `https` endpoint generated by `ngrok` for your `Payload URL` when setting
up the webhook.

[flint]: https://github.com/weaveworks/flintlock
[ngrok]: https://ngrok.com/
